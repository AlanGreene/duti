SHELL = /bin/sh

srcdir = @srcdir@
VPATH = @srcdir@

prefix=@prefix@
exec_prefix=@exec_prefix@
BINDIR=@bindir@
MANDIR=@mandir@

DUTI_BUILD_DATE=@build_date@

CC=		@CC@
FRAMEWORKS=	-framework ApplicationServices -framework CoreFoundation
OPTOPTS=	-isysroot @macosx_sdk@ \
			-arch i386 -arch ppc \
			@OPTOPTS@

LIBS=		@LIBS@
LDFLAGS=	@LDFLAGS@ ${LIBS}
CFLAGS=		${OPTOPTS} @CFLAGS@
INSTALL=	@INSTALL@

TARGETS=	duti
MAN1TARGETS=	duti.1
MANTARGETS=	${MAN1TARGETS}

DUTI_OBJ=	version.o util.o plist.o handler.o duti.o

all : ${TARGETS}

version.o : version.c
	${CC} ${CFLAGS} -c ${srcdir}/version.c

duti.o : duti.c
	${CC} ${CFLAGS} -c ${srcdir}/duti.c

handler.o : handler.c
	${CC} ${CFLAGS} -c ${srcdir}/handler.c

plist.o : plist.c
	${CC} ${CFLAGS} -c ${srcdir}/plist.c

util.o : util.c
	${CC} ${CFLAGS} -c ${srcdir}/util.c

duti : ${DUTI_OBJ}
	${CC} ${FRAMEWORKS} ${CFLAGS} -o duti ${DUTI_OBJ} ${LDFLAGS}

VERSION=$(shell date +%Y%m%d)
DISTDIR=../duti-${VERSION}

dist : distclean
	mkdir ${DISTDIR}
	tar -h -c -f - -X EXCLUDE . | tar xpf - -C ${DISTDIR}
	echo ${VERSION} > ${DISTDIR}/VERSION
	sed -e "s@INTERNAL@${VERSION}@" \
		< configure.ac > ${DISTDIR}/configure.ac
	(cd "${DISTDIR}"; autoconf; rm -rf autom4te.cache)
	for i in ${MANTARGETS}; do \
	    sed -e 's@_DUTI_BUILD_DATE@${DUTI_BUILD_DATE}@g' \
		    ${DISTDIR}/$$i > ${DISTDIR}/$$i.tmp; \
	    mv -f ${DISTDIR}/$$i.tmp ${DISTDIR}/$$i; \
	done
	tar cvfz ${DISTDIR}.tar.gz ${DISTDIR}
	for c in sha1 rmd160 md5; do \
	    openssl $$c ${DISTDIR}.tar.gz; \
	done

install : all
	-mkdir -p ${DESTDIR}${BINDIR}
	${INSTALL} -m 0755 -c ${TARGETS} ${DESTDIR}${BINDIR}/
	-mkdir -p ${DESTDIR}${MANDIR}/man1
	${INSTALL} -m 0644 -c ${MAN1TARGETS} ${DESTDIR}${MANDIR}/man1/

clean :
	rm -f *.o a.out core
	rm -f ${TARGETS}
	rm -rf tmp

distclean : clean
	rm -f config.log config.status config.cache Makefile version.c
	rm -rf autom4te.cache
	rm -rf .#*
